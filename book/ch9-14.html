---
layout: master
title: Pro Git 9.14 Git Internals Removing Objects
---
<h2 id='removing_objects'>Removing Objects</h2>

<p>There are a lot of great things about Git, but one feature that can cause issues is the fact that a Git clone will download the <em>entire</em> history of the project, including every version of every file. This is fine if the whole thing is source code, since Git is highly optimized to compress that data efficiently. However, if someone at any point in the history of your project added a single huge file, every clone for all time in the future will be forced to download that large file, even if it was removed from the project in the very next commit. Since it is reachable from the history, it will always be there.</p>

<p>This is a huge problem when converting Subversion or Perforce repositories into Git, since you don&#8217;t download the whole history in those systems this type of addition carries few consequences. If you find you did an import from another system or otherwise find that your repository is much larger than it should be, this is how you can find and remove large objects from your repository.</p>

<p>Be warned - this is destructive to your commit objects - it will rewrite every commit object upstream from the earliest tree you have to modify to remove a large file reference. If you do this immediately after an import before anyone has started to base work on it, you&#8217;re fine - otherwise you have to notify all contributors that they will have to rebase their work onto your new commits.</p>

<p>To demonstrate this, we will add a large file into our test repository, then remove it in the next commit, then we will find and remove it permenantly from our repository. First let&#8217;s add our large object to our history:</p>

<pre><code>$ curl http://kernel.org/pub/software/scm/git/git-1.6.3.1.tar.bz2 &gt; git.tbz2
$ git add git.tbz2
$ git commit -am &#39;added git tarball&#39;
[master 6df7640] added git tarball
 1 files changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 git.tbz2</code></pre>

<p>Oops, we didn&#8217;t want to add a huge tarball to our project, let&#8217;s get rid of it:</p>

<pre><code>$ git rm git.tbz2 
rm &#39;git.tbz2&#39;
$ git commit -m &#39;oops - removed large tarball&#39;
[master da3f30d] oops - removed large tarball
 1 files changed, 0 insertions(+), 0 deletions(-)
 delete mode 100644 git.tbz2</code></pre>

<p>Now let&#8217;s <code>gc</code> our database and see how much space we&#8217;re using up:</p>

<pre><code>$ git gc
Counting objects: 21, done.
Delta compression using 2 threads.
Compressing objects: 100% (16/16), done.
Writing objects: 100% (21/21), done.
Total 21 (delta 3), reused 15 (delta 1)</code></pre>

<p>We can run a command called <code>count-objects</code> to quickly see how much space we&#8217;re using:</p>

<pre><code>$ git count-objects -v
count: 4
size: 16
in-pack: 21
packs: 1
size-pack: 2016
prune-packable: 0
garbage: 0</code></pre>

<p>The <code>size-pack</code> entry is the size of our packfiles floored to the nearest kilobyte, so we&#8217;re using 2 megs. Before that last commit we were using closer to 2k, so clearly removing the file from our last commit did not remove it from our history - every time anyone clones this repository they will have to clone all 2 megs just to get this tiny project because I accidentally added a big file one time. Let&#8217;s get rid of it.</p>

<p>First, we have to find it - in this case we already know what file it is, but let&#8217;s say that we didn&#8217;t, how would we identify what file or files are taking up so much space? If we run <code>git gc</code>, all the objects should be in a packfile and we should be able to identify the big objects by running <code>git verify-pack</code> and sorting on the third field, which is file size:</p>

<pre><code>$ git verify-pack -v .git/objects/pack/pack-3f8c0...bb.idx | sort -k 3 -n | tail -3
e3f094f522629ae358806b17daf78246c27c007b blob   1486 734 4667
05408d195263d853f09dca71d55116663690c27c blob   12908 3478 1189
7a9eb2fba2b1811321254ac360970fc169ba2330 blob   2056716 2056872 5401</code></pre>

<p>So there is our big object there at the bottom - 2 megs. Let&#8217;s find our what file that is. We are going to use a command called <code>rev-list</code> that we use briefly in Chapter 7 as well. If you pass <code>--objects</code> to <code>rev-list</code> it will not only list out all the commit SHAs but also the blob SHAs with the file paths associated with them. We can use this to find what our blob was named.</p>

<pre><code>$ git rev-list --objects --all | grep 7a9eb2fb
7a9eb2fba2b1811321254ac360970fc169ba2330 git.tbz2</code></pre>

<p>So now we need to remove this file from all trees in our past. We can see what commits modified this file pretty easily:</p>

<pre><code>$ git log --pretty=oneline -- git.tbz2
da3f30d019005479c99eb4c3406225613985a1db oops - removed large tarball
6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 added git tarball</code></pre>

<p>So we need to rewrite all the commits upstream from <code>6df76</code> to fully remove this file from our Git history. We will use <code>filter-branch</code> to do this relatively easily.</p>

<pre><code>$ git filter-branch --index-filter &#39;git rm --cached --ignore-unmatch git.tbz2&#39; -- 6df7640^..
Rewrite 6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 (1/2)rm &#39;git.tbz2&#39;
Rewrite da3f30d019005479c99eb4c3406225613985a1db (2/2)
Ref &#39;refs/heads/master&#39; was rewritten</code></pre>

<p>DWP: So what do all the options in there do?</p>

<p>So now our history does not contain a reference to that file anymore. However, our reflog and a new refs directory Git added when we did the filter-branch called &#8216;original&#8217; still do, so we&#8217;ll have to remove them and then repack the database.</p>

<pre><code>$ rm -Rf .git/refs/original
$ rm -Rf .git/logs/
$ git gc
Counting objects: 19, done.
Delta compression using 2 threads.
Compressing objects: 100% (14/14), done.
Writing objects: 100% (19/19), done.
Total 19 (delta 3), reused 16 (delta 1)</code></pre>

<p>Now let&#8217;s see how much space we saved.</p>

<pre><code>$ git count-objects -v
count: 8
size: 2040
in-pack: 19
packs: 1
size-pack: 7
prune-packable: 0
garbage: 0</code></pre>

<p>Now our packed repository size is down to 7k, which is much better than 2 megs. You can see from the &#8216;size&#8217; value that the big object is still in our loose objects, so it&#8217;s not <em>gone</em>, but it will not be transferred on a push or subsequent clone, which is what is important. If you really wanted to, you could remove the object completely by running <code>git prune --expire now</code>.</p>

<div id='nav'>
<a href='ch9-13.html'>prev</a> | <a href='ch9-15.html'>next</a>
</div>